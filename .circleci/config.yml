version: 2.1

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/node:20.9
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Instalar Railway CLI
          command: |
            npm i -g @railway/cli
            railway --version

      - run:
          name: Login Railway con token (no interactivo)
          command: |
            railway whoami || railway login --apiKey "$RAILWAY_TOKEN"

      - run:
          name: Linkear proyecto (evita prompts)
          command: |
            if [ -n "$RAILWAY_PROJECT_ID" ]; then
              railway link -p "$RAILWAY_PROJECT_ID"
            fi
            railway status || true

      - run:
          name: Desplegar a Railway
          command: |
            cd bankchurn-api
            if [ -n "$RAILWAY_SERVICE_NAME" ]; then
              railway up --service "$RAILWAY_SERVICE_NAME" --detach
            else
              railway up --service "serene-spontaneity" --detach
            fi

workflows:
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway
